<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>图床文件管理</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h2 { margin-bottom: 10px; }
        ul { list-style: none; padding-left: 20px; }
        li { margin: 5px 0; }
        .dir { font-weight: bold; cursor: pointer; }
        .file { color: #555; }
    </style>
</head>
<body>

<h2>📂 文件浏览</h2>
<div id="currentPath">当前路径: /</div>
<ul id="fileList"></ul>

<h2>📤 上传文件</h2>
<form id="uploadForm">
    <input type="file" name="file" required>
    <button type="submit">上传</button>
</form>

<script>
let currentPath = "";

async function loadFiles(path = "") {
    currentPath = path;
    document.getElementById("currentPath").innerText = "当前路径: /" + path;
    const res = await fetch(`/list?path=${encodeURIComponent(path)}`);
    if (!res.ok) {
        alert("加载文件失败");
        return;
    }
    const data = await res.json();
    const fileList = document.getElementById("fileList");
    fileList.innerHTML = "";

    // 如果不是根目录，显示返回上级
    if (path) {
        const li = document.createElement("li");
        li.innerHTML = `<span class="dir">⬅️ 返回上级</span>`;
        li.onclick = () => {
            const parent = path.split("/").slice(0, -1).join("/");
            loadFiles(parent);
        };
        fileList.appendChild(li);
    }

    data.files.forEach(item => {
        const li = document.createElement("li");
        if (item.type === "directory") {
            li.innerHTML = `<span class="dir">📁 ${item.name}</span>`;
            li.onclick = () => loadFiles(path ? `${path}/${item.name}` : item.name);
        } else {
            li.innerHTML = `<a class="file" href="/files/${path ? path + '/' : ''}${item.name}" target="_blank">🖼️ ${item.name}</a>`;
        }
        fileList.appendChild(li);
    });
}

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    formData.append("targetPath", currentPath);

    const res = await fetch("/upload", {
        method: "POST",
        body: formData
    });
    if (res.ok) {
        alert("上传成功！");
        loadFiles(currentPath);
    } else {
        alert("上传失败");
    }
});

loadFiles();
</script>

</body>
</html>
